<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra Cứu Đơn Hàng</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Roboto', sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
      }

      /* Header styles */
      .header {
        display: flex;
        align-items: center;
        padding: 10px 40px;
        background-color: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        position: fixed;
        width: 100%;
        height: 60px;
        top: 0;
        left: 0;
        z-index: 1000;
        box-sizing: border-box;
      }

      .logo {
        height: 40px;
        width: auto;
      }

      .nav {
        margin-left: 30px;
        display: flex;
        gap: 20px;
        align-items: center;
      }

      .nav-item {
        position: relative;
        padding: 10px 15px;
        color: #333;
        text-decoration: none;
        font-weight: 500;
        line-height: 40px;
        border-radius: 4px;
        transition: all 0.3s ease;
      }

      .nav-item:hover {
        background-color: #f5f5f5;
      }

      .dropdown {
        position: relative;
        display: inline-block;
      }

      .dropdown-content {
        display: none;
        position: absolute;
        background-color: white;
        min-width: 200px;
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        z-index: 1;
        border-radius: 4px;
        top: calc(100% + 5px);
        left: 0;
        border-top: 3px solid #275284;
      }

      .dropdown:hover .dropdown-content {
        display: block;
      }

      .dropdown-content a {
        color: #333;
        padding: 10px 15px;
        text-decoration: none;
        display: block;
        border-bottom: 1px solid #eee;
        line-height: 1.5;
      }

      .dropdown-content a:last-child {
        border-bottom: none;
      }

      .dropdown-content a:hover {
        background-color: #275284;
        color: white;
      }

      /* Main content */
      .container {
        width: 95%;
        max-width: 1600px;
        margin: 80px auto 0;
        padding: 20px;
      }

      h1 {
        color: #275284;
        margin: 20px 0 30px;
        text-align: center;
        font-weight: 500;
      }

      .search-container {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap;
        justify-content: space-between;
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }

      .search-box {
        display: flex;
        gap: 10px;
        flex: 1;
        max-width: 600px;
      }

      input[type="text"] {
        padding: 12px 15px;
        width: 100%;
        border: 2px solid #e1e5eb;
        border-radius: 8px;
        font-size: 15px;
        transition: all 0.3s;
      }

      button {
        padding: 12px 20px;
        background-color: #275284;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        cursor: pointer;
        transition: all 0.3s;
      }

      button:hover {
        background-color: #1a3a5f;
      }

      .viber-button {
        background-color: #665CAC;
        text-decoration: none;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 15px;
        transition: all 0.3s;
      }

      /* Table styles */
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        table-layout: fixed;
      }

      th, td {
        padding: 8px 10px;
        text-align: left;
        border: 1px solid #e1e5eb;
        font-size: 14px;
        line-height: 1.5;
        vertical-align: middle;
      }

      th {
        background-color: #275284;
        color: white;
        font-weight: 500;
      }

      tr:hover {
        background-color: #f8f9fa;
      }

      /* Footer styles */
      .footer {
        text-align: center;
        padding: 20px;
        margin-top: 30px;
        border-top: 1px solid #ddd;
        color: #666;
        font-size: 14px;
        font-weight: 300;
      }

      .footer a {
        color: #275284;
        text-decoration: none;
        font-weight: 500;
      }

      .footer a:hover {
        text-decoration: underline;
      }

      /* Adjust container margin for fixed header */
      .container {
        margin-top: 90px;
      }

      /* Responsive header */
      @media screen and (max-width: 768px) {
        .header {
          flex-direction: column;
          align-items: flex-start;
          height: auto;
          position: relative;
        }

        .nav {
          margin-left: 0;
          margin-top: 10px;
          flex-direction: column;
          width: 100%;
          height: auto;
        }

        .nav-item {
          width: 100%;
          padding: 15px;
          border-bottom: 1px solid #eee;
        }

        .dropdown-content {
          position: static;
          box-shadow: none;
          margin-left: 20px;
          border-top: none;
        }

        .container {
          margin-top: 20px;
        }
      }

      /* Responsive */
      @media screen and (max-width: 768px) {
        .header {
          position: relative;
          height: auto;
          padding: 10px;
        }

        .container {
          width: 100%;
          margin-top: 0;
          padding: 10px;
        }

        .search-container {
          flex-direction: column;
        }

        .search-box {
          max-width: 100%;
        }

        table {
          display: block;
          overflow-x: auto;
        }

        th, td {
          min-width: 120px;
        }
      }

      /* Pagination styles */
      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      .pagination button {
        padding: 8px 16px;
        border: 1px solid #ddd;
        background-color: white;
        color: #275284;
        cursor: pointer;
        border-radius: 4px;
        font-size: 14px;
        min-width: 40px;
        transition: all 0.3s ease;
      }

      .pagination button:hover {
        background-color: #f5f5f5;
        border-color: #275284;
      }

      .pagination button.active {
        background-color: #275284;
        color: white;
        border-color: #275284;
      }

      .pagination button:disabled {
        background-color: #f5f5f5;
        color: #999;
        cursor: not-allowed;
        border-color: #ddd;
      }

      /* Điều chỉnh lại style cho các buttons khác */
      .search-button, .filter-button, .export-button {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .search-button {
        background-color: #275284;
        color: white;
      }

      .filter-button {
        background-color: #4CAF50;
        color: white;
      }

      .export-button {
        background-color: #f0ad4e;
        color: white;
      }

      .button-icon {
        margin-right: 8px;
      }

      /* Điều chỉnh độ rộng cho từng cột */
      .checker-column { width: 40px; }
      .date-column { width: 80px; }
      .schedule-column { width: 80px; }
      .status-column { 
          width: 100px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
      }
      .order-code-column { width: 130px; }
      .private-code-column { width: 120px; }
      .customer-column { width: 200px; }
      .address-column { width: 250px; }
      .payment-column { width: 100px; }
      .amount-column { width: 100px; }
      .shipping-column { width: 100px; }
      .delivery-time-column { width: 130px; }
      .note-column { width: 120px; }

      /* Style cho các ô trong bảng */
      td {
          height: 50px;
          vertical-align: middle;
      }

      /* Style cho các cột cần căn giữa */
      .amount-column, .shipping-column, .delivery-time-column {
          text-align: center;
      }

      /* Style cho cột ghi chú */
      .note-column {
          text-align: left;
          vertical-align: middle;
          white-space: normal;
          word-break: break-word;
      }

      /* Style cho status badges */
      .status-finished, .status-waiting, .status-internal,
      .status-delivery, .status-wod, .status-cancelled,
      .status-confirmed, .status-new, .status-be-cancelled {
          padding: 4px 8px;
          border-radius: 12px;
          font-size: 13px;
          font-weight: 500;
          display: inline-block;
          text-align: center;
          min-width: 80px;
          max-width: 90px;
          color: white;
          box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }

      /* Màu cho từng trạng thái */
      .status-finished { background-color: #4CAF50; } /* Đã giao - Màu xanh lá */
      .status-waiting { background-color: #F44336; } /* Tạm huỷ - Màu đỏ */
      .status-internal { background-color: #9C27B0; } /* Chuyển kho - Màu tím */
      .status-delivery { background-color: #2196F3; } /* Đang giao - Màu xanh dương */
      .status-wod { background-color: #9126f0; } /* Nhập kho giao - Màu tím nhạt */
      .status-cancelled { background-color: #F44336; } /* Tạm huỷ - Màu đỏ */
      .status-confirmed { background-color: #ffc266; } /* Đã xác nhận - Màu cam */
      .status-new { background-color: #1ac6ff; } /* Mới - Màu xanh nhạt */
      .status-be-cancelled { background-color: #F44336; } /* Đã bị huỷ - Màu đỏ */

      /* Các cột cần căn giữa */
      .status-column, .payment-column, .amount-column, 
      .shipping-column, .delivery-time-column {
          text-align: center;
      }

      /* Đảm bảo status badge không bị tràn */
      td.status-column span {
          width: 100%;
          box-sizing: border-box;
      }

      /* Điều chỉnh style cho các cột có nội dung dài */
      .customer-column, .address-column {
          white-space: normal;
          word-break: break-word;
          line-height: 1.4;
      }

      /* Đảm bảo tất cả các ô đều có padding đồng nhất */
      th, td {
          padding: 8px 10px;
          text-align: left;
          border: 1px solid #e1e5eb;
          font-size: 14px;
          line-height: 1.5;
          vertical-align: middle;
      }

      /* Responsive table */
      @media screen and (max-width: 1600px) {
        table {
          display: block;
          overflow-x: auto;
          white-space: nowrap;
        }
        
        th, td {
          min-width: unset;
        }

        /* Giữ nguyên độ rộng cột khi scroll */
        .private-code-column, .address-column {
          min-width: 120px;
          max-width: 120px;
        }
      }

      /* Thêm style cho loading overlay */
      .loading-overlay {
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(255, 255, 255, 0.9);
          z-index: 9999;
          justify-content: center;
          align-items: center;
          flex-direction: column;
      }

      .loading-spinner {
          width: 50px;
          height: 50px;
          border: 5px solid #f3f3f3;
          border-top: 5px solid #275284;
          border-radius: 50%;
          animation: spin 1s linear infinite;
      }

      .loading-text {
          margin-top: 15px;
          color: #275284;
          font-weight: 500;
      }

      /* Style cho notification */
      .notification {
          position: fixed;
          top: 20px;
          right: 20px;
          padding: 15px 25px;
          border-radius: 8px;
          color: white;
          font-weight: 500;
          opacity: 0;
          transform: translateY(-20px);
          transition: all 0.3s ease;
          z-index: 9999;
      }

      .notification.success {
          background-color: #4CAF50;
      }

      .notification.error {
          background-color: #f44336;
      }

      .notification.visible {
          opacity: 1;
          transform: translateY(0);
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      /* Responsive design cho các thiết bị */
      @media screen and (max-width: 1600px) {
          .container {
              width: 98%;
              margin: 70px auto 0;
          }
      }

      @media screen and (max-width: 1200px) {
          table {
              display: block;
              overflow-x: auto;
              white-space: nowrap;
          }
          
          .container {
              padding: 10px;
          }
      }

      /* Tablet */
      @media screen and (max-width: 1024px) {
          .header {
              padding: 10px 20px;
          }
          
          .search-container {
              flex-direction: column;
              gap: 10px;
          }
          
          .search-box {
              width: 100%;
              max-width: none;
          }
          
          button {
              width: 100%;
          }
      }

      /* Mobile */
      @media screen and (max-width: 768px) {
          .header {
              position: relative;
              height: auto;
              padding: 10px;
          }

          .nav {
              flex-direction: column;
              margin-left: 0;
              width: 100%;
          }

          .container {
              margin-top: 20px;
          }

          h1 {
              font-size: 24px;
          }

          .search-container {
              padding: 15px;
          }

          input[type="text"] {
              font-size: 14px;
          }

          button {
              font-size: 14px;
              padding: 10px 15px;
          }

          th, td {
              padding: 6px 8px;
              font-size: 13px;
          }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <img src="https://i.ibb.co/RDn390c/logo-final-01.png" alt="Logo" class="logo">
      <nav class="nav">
        <div class="dropdown">
          <a href="#" class="nav-item">Tra cứu</a>
          <div class="dropdown-content">
            <a href="https://ymedgroup.github.io/lpcheck/">Tra cứu đơn Mekong</a>
            <a href="https://ymedgroup.github.io/ymed/">Tra cứu đơn YMED</a>
          </div>
        </div>
        <div class="dropdown">
          <a href="#" class="nav-item">Tồn kho</a>
          <div class="dropdown-content">
            <a href="https://ymedgroup.github.io/tonkhosale/">Tồn kho HCM</a>
            <a href="https://ymedgroup.github.io/warehousehn/">Tồn kho HN</a>
            <a href="#" onclick="checkPassword(); return false;">Tồn kho toàn quốc</a>
          </div>
        </div>
      </nav>
    </div>

    <div class="container">
    <h1>Tra Cứu Đơn Hàng</h1>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Đang tải dữ liệu...</div>
    </div>

    <div id="notification" class="notification">
        <span id="notificationMessage"></span>
    </div>
      
    <div class="search-container">
        <div class="search-box">
      <input type="text" id="privateCode" placeholder="Nhập mã đơn hàng, tên khách hàng,... để tra cứu">
          <button id="searchBtn" type="button" onclick="fetchOrders()">
            <i class="fas fa-search"></i>
            Tra Cứu
          </button>
        </div>
        <a href="viber://chat?number=%2B84915665422" target="_self" class="viber-button">
          <i class="fab fa-viber"></i>
          Liên hệ kho qua Viber
        </a>
    </div>

      <div id="filterContainer">
	  <label for="columnSelect">Chọn cột:</label>
        <select id="columnSelect">
		<option value="">-- Chọn cột --</option>
		<option value="orders_created">Ngày đơn hàng</option>
		<option value="orders_status">Trạng thái</option>
		<option value="private_code">Đơn đặt hàng</option>
		<option value="mode_of_payment">Thanh toán</option>
	  </select>
        <select id="valueSelect">
		<option value="">-- Chọn giá trị --</option>
	  </select>
        <button id="applyFilterBtn">Áp dụng lọc</button>
	</div>

    <button id="exportBtn" type="button" onclick="exportSelectedOrders()">Xuất Dữ Liệu</button>
    <table id="ordersTable">
      <thead>
        <tr>
          <th class="checker-column">Checker</th>
          <th>Ngày đơn hàng</th>
          <th>Lịch giao hàng</th>
          <th class="status-column">Trạng thái</th>
          <th>Mã đơn hàng</th>
          <th class="long-text">Đơn đặt hàng</th>
          <th>Khách hàng</th>
          <th>Địa chỉ giao</th>
          <th class="payment">Thanh toán</th>
          <th class="amount">Giá trị đơn</th>
          <th class="shipping-fee">Phí giao hàng</th>
          <th>Thời gian giao</th>
          <th class="hidden">Ghi chú</th>
        </tr>
      </thead>
      <tbody id="ordersBody"></tbody>
    </table>
      <div class="pagination"></div>
      <div class="footer">
        <p>© 2024 Tra cứu tồn kho Cloudify</p>
        <p>Được phát triển bởi <a href="">Trần Văn Tiến Anh</a> và Claude (AI)</p>
      </div>
    </div>

    <!-- Add Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script>
      let isFirstLoad = true;
      let cachedOrders = [];
      let filteredOrders = null;
      let currentPage = 1;
      const itemsPerPage = 30;

      async function fetchOrders() {
        try {
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            const privateCode = document.getElementById('privateCode').value;
            let filterString = '';
            if (privateCode) {
                filterString = `(((contains(private_code,'${privateCode}')) or (contains(orders_cancel_reason,'${privateCode}')) or (contains(orders_code,'${privateCode}')) or (contains(orders_temp_cancel_full_reason,'${privateCode}')) or (contains(orders_temp_cancel_reason,'${privateCode}')) or (contains(pod_districts,'${privateCode}')) or (contains(orders_customer_name,'${privateCode}'))))`
            }

            const response = await fetch("https://giaoduocpham.vn/graphql", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer BAJ2DY4ZoepiEXmAd,7670d8f330af99fa7f34e9d2158e0b7a2d50dba546f10074fdf5aa41f5cf75ecf2e0295951522e20395bca"
                },
                body: JSON.stringify({
                    query: `{records: orders(skip: 0, top: 999, filters: "${filterString}") {_id,orders_code,private_code,orders_status,orders_amount,orders_fee_aft_vat,orders_pod_name,orders_customer_name,orders_created,mode_of_payment,time_delivery_reality,orders_delivery_schedule__expand {_id,delivery_schedule_name} orders_temp_cancel_note},count: orders__count}`
                })
            });

            const data = await response.json();
            
            if (data.data.records.length === 0) {
                showNotification('Không tìm thấy đơn hàng', 'error');
            } else {
                showNotification(`Đã tìm thấy ${data.data.records.length} đơn hàng`, 'success');
            }

            cachedOrders = data.data.records;
            filteredOrders = null;
            currentPage = 1;
            renderOrders(cachedOrders);
            isFirstLoad = false;

        } catch (error) {
            showNotification('Đã có lỗi xảy ra khi tải dữ liệu', 'error');
            console.error('Error:', error);
        } finally {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
      }

      function renderOrders(orders) {
        const ordersBody = document.getElementById('ordersBody');
        ordersBody.innerHTML = '';
        
        // Sắp xếp đơn hàng từ mới đến cũ
        orders.sort((a, b) => new Date(b.orders_created) - new Date(a.orders_created));
        
        // Tính toán phân trang
        const totalPages = Math.ceil(orders.length / itemsPerPage);
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, orders.length);
        const paginatedOrders = orders.slice(startIndex, endIndex);

        // Hiển thị dữ liệu
        paginatedOrders.forEach(order => {
          const createdDate = new Date(order.orders_created).toLocaleDateString();
          const status = {
            finished: `
						<span class="status-finished">Đã giao</span>`,
            waiting_temp_canceled: `
						<span class="status-waiting">Tạm huỷ</span>`,
            internal_transport: `
						<span class="status-internal">Chuyển kho</span>`,
            delivery: `
						<span class="status-delivery">Đang giao</span>`,
            wod_confirmed: `
						<span class="status-wod">Nhập kho giao</span>`,
            temp_cancelled: `
						<span class="status-cancelled">Tạm huỷ</span>`,
            lp_confirmed: `
						<span class="status-confirmed">Đã xác nhận</span>`,
            new: `
						<span class="status-new">Mới(Đã đóng gói)</span>`,
            cancelled: `
						<span class="status-be-cancelled">Đã bị huỷ</span>`
          } [order.orders_status] || order.orders_status;
          const paymentMethod = {
            bank: 'Không thu hộ',
            cash: 'COD'
          } [order.mode_of_payment] || order.mode_of_payment;
          const row = document.createElement('tr');
          row.innerHTML = `
						<td class="checker-cell">
							<input type="checkbox" class="order-checkbox">
							</td>
							<td class="date-column">${createdDate}</td>
							<td class="schedule-column" title="${order.orders_delivery_schedule__expand?.delivery_schedule_name || ''}">${order.orders_delivery_schedule__expand?.delivery_schedule_name || ''}</td>
							<td class="status-column centered">${status}</td>
							<td class="order-code-column" title="${order.orders_code}">${order.orders_code}</td>
							<td class="private-code-column" title="${order.private_code}">${order.private_code}</td>
							<td class="customer-column" title="${order.orders_customer_name}">${order.orders_customer_name}</td>
							<td class="address-column" title="${order.orders_pod_name}">${order.orders_pod_name}</td>
							<td class="payment-column centered">${paymentMethod}</td>
							<td class="amount-column centered">${order.orders_amount?order.orders_amount.toLocaleString('vi-VN'):0}</td>
							<td class="shipping-column centered">${order.orders_fee_aft_vat?order.orders_fee_aft_vat.toLocaleString('vi-VN'):0}</td>
							<td class="delivery-time-column">${order.time_delivery_reality?new Date(order.time_delivery_reality).toLocaleString():''}</td>
							<td class="note-column" title="${order.orders_temp_cancel_note||''}">${order.orders_temp_cancel_note||''}</td>`;
          ordersBody.appendChild(row)
        });
        const noteHeader = document.querySelector('th:nth-child(13)');
        const rows = document.querySelectorAll('#ordersTable tr');
        const hasNotes = paginatedOrders.some(order => order.orders_temp_cancel_note);
        if (hasNotes) {
          rows.forEach(row => {
            row.cells[11].style.display = '';
            noteHeader.classList.remove('hidden')
          })
        } else {
          rows.forEach(row => {
            row.cells[11].style.display = 'none'
          })
        }
        renderPagination(orders.length, totalPages);
      }

      function renderPagination(totalItems, totalPages) {
        const pagination = document.querySelector('.pagination');
        pagination.innerHTML = '';

		  if (totalPages <= 1) return;

        // Nút Trước
		  if (currentPage > 1) {
            pagination.appendChild(createPageButton('Trước', currentPage - 1));
        }
        
        // Các nút số trang
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, currentPage + 2);
        
        // Đảm bảo luôn hiển thị 5 nút số trang nếu có thể
        if (endPage - startPage < 4) {
            if (startPage === 1) {
                endPage = Math.min(5, totalPages);
            } else {
                startPage = Math.max(1, totalPages - 4);
            }
        }

        // Hiển thị các nút số trang
		  for (let i = startPage; i <= endPage; i++) {
            const button = createPageButton(i, i);
            if (i === currentPage) {
                button.classList.add('active');
            }
            pagination.appendChild(button);
        }
        
        // Nút Tiếp
		  if (currentPage < totalPages) {
            pagination.appendChild(createPageButton('Tiếp', currentPage + 1));
        }
    }

    function createPageButton(text, page, disabled = false) {
        const button = document.createElement('button');
        button.textContent = text;
        if (disabled) {
            button.disabled = true;
            return button;
        }
        button.addEventListener('click', () => {
            if (page !== null) {
                currentPage = page;
                renderOrders(filteredOrders || cachedOrders);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });
        return button;
    }

    function goToPage(page) {
        currentPage = page;
        renderOrders(filteredOrders || cachedOrders);
    }

		  window.onload = fetchOrders;
		  document.getElementById('searchBtn').addEventListener('click', () => {
			cachedOrders = [];
			fetchOrders()
		  });

		function exportSelectedOrders() {
		  const checkboxes = document.querySelectorAll('.order-checkbox');
		  const selectedOrders = [];

		  checkboxes.forEach((checkbox) => {
			if (checkbox.checked) {
			  const row = checkbox.closest('tr');
			  const cells = Array.from(row.querySelectorAll('td')).slice(1);
			  const orderData = cells.map(cell => cell.innerText);
			  selectedOrders.push(orderData);
			}
		  });

		  // Nếu không có đơn hàng nào được chọn, chuyển đổi dữ liệu thô thành dữ liệu tinh chỉnh
		  const exportData = selectedOrders.length > 0 ? selectedOrders : cachedOrders.map(order => [
			// Chuyển đổi ngày thành định dạng dễ đọc
			new Date(order.orders_created).toLocaleDateString('vi-VN'),

			// Lịch giao hàng
			order.orders_delivery_schedule__expand.delivery_schedule_name || '',

			// Chuyển đổi mã trạng thái thành tên trạng thái dễ hiểu
			{
			  finished: 'Đã giao',
			  waiting_temp_canceled: 'Tạm huỷ',
			  internal_transport: 'Chuyển kho',
			  delivery: 'Đang giao',
			  wod_confirmed: 'Nhập kho giao',
			  temp_cancelled: 'Tạm huỷ',
			  lp_confirmed: 'Đã xác nhận',
			  new: 'Mới (Đã đóng gói)',
			  cancelled: 'Đã bị huỷ'
			}[order.orders_status] || order.orders_status,

			// Mã đơn hàng
			order.orders_code,

			// Đơn đặt hàng
			order.private_code,

			// Tên khách hàng
			order.orders_customer_name,

			// Địa chỉ giao hàng
			order.orders_pod_name,

			// Phương thức thanh toán (COD hoặc Không thu hộ)
			order.mode_of_payment === 'cash' ? 'COD' : 'Không thu hộ',

			// Giá trị đơn hàng, định dạng tiền tệ
			order.orders_amount ? order.orders_amount.toLocaleString('vi-VN') : 0,

			// Phí giao hàng, định dạng tiền tệ
			order.orders_fee_aft_vat ? order.orders_fee_aft_vat.toLocaleString('vi-VN') : 0,

			// Thời gian giao thực tế, định dạng ngày giờ
			order.time_delivery_reality ? new Date(order.time_delivery_reality).toLocaleString('vi-VN') : '',

			// Ghi chú, nếu có
			order.orders_temp_cancel_note || ''
		  ]);

		  // Tạo workbook và worksheet
		  const wb = XLSX.utils.book_new();
		  const wsData = [
			["Ngày đơn hàng", "Lịch giao hàng", "Trạng thái", "Mã đơn hàng", "Đơn đặt hàng", "Khách hàng", "Địa chỉ giao", "Thanh toán", "Giá trị đơn", "Phí giao hàng", "Thời gian giao", "Ghi chú"], 
			...exportData
		  ];
		  const ws = XLSX.utils.aoa_to_sheet(wsData);

		  // Tùy chỉnh cột tự động, font chữ, in đậm header và bo viền
		  wsData.forEach((row, rowIndex) => {
			row.forEach((_, colIndex) => {
			  const cellAddress = XLSX.utils.encode_cell({ r: rowIndex, c: colIndex });
			  if (!ws[cellAddress]) return;

			  ws[cellAddress].s = {
				font: {
				  name: "Times New Roman",
				  sz: 12,
				  bold: rowIndex === 0
				},
				alignment: {
				  vertical: "center",
				  horizontal: "center",
				  wrapText: true
				},
				border: {
				  top: { style: "thin" },
				  bottom: { style: "thin" },
				  left: { style: "thin" },
				  right: { style: "thin" }
				}
			  };
			});
		  });

		  // Tự động điều chỉnh độ rộng cột
		  ws['!cols'] = wsData[0].map(() => ({ wch: 20 }));

		  XLSX.utils.book_append_sheet(wb, ws, "Orders");

		  const today = new Date();
		  const fileName = `LP_Data_${today.getDate()}_${today.getMonth() + 1}.xlsx`;
		  XLSX.writeFile(wb, fileName);
		  
		  showNotification("Đã xuất thành công", "success");
		}

      function showNotification(message, type) {
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notificationMessage');
        notificationMessage.textContent = message;
        notification.className = `notification ${type} visible`;
        
        setTimeout(() => {
            notification.classList.remove('visible');
        }, 3000);
      }

	function formatDisplayedValue(column, value) {
	  if (column === 'orders_created') {
		const date = new Date(value);
		return `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
	  } else if (column === 'orders_status') {
		const statusMap = {
		  finished: 'Đã giao',
		  waiting_temp_canceled: 'Tạm huỷ',
		  internal_transport: 'Chuyển kho',
		  delivery: 'Đang giao',
		  wod_confirmed: 'Nhập kho giao',
		  temp_cancelled: 'Tạm huỷ',
		  lp_confirmed: 'Đã xác nhận',
		  new: 'Mới (Đã đóng gói)',
		  cancelled: 'Đã bị huỷ'
		};
		return statusMap[value] || value;
	  } else if (column === 'mode_of_payment') {
		const paymentMap = {
		  cash: 'COD',
		  bank: 'Không thu hộ'
		};
		return paymentMap[value] || value;
	  }
	  return value;
	}

	function updateFilterOptions() {
	  const column = document.getElementById('columnSelect').value;
	  const valueSelect = document.getElementById('valueSelect');
	  valueSelect.innerHTML = '<option value="">-- Chọn giá trị --</option>';

	  if (!column) return;

	  const uniqueValues = [...new Set(cachedOrders.map(order => formatDisplayedValue(column, order[column])))];
	  uniqueValues.forEach(displayedValue => {
		const rawValue = cachedOrders.find(order => formatDisplayedValue(column, order[column]) === displayedValue)[column];
		const option = document.createElement('option');
        option.value = rawValue;
        option.textContent = displayedValue;
		valueSelect.appendChild(option);
	  });
	}

	function applyFilter() {
	  const column = document.getElementById('columnSelect').value;
	  const rawValue = document.getElementById('valueSelect').value;

	  if (!column || !rawValue) {
		alert("Vui lòng chọn cả cột và giá trị để lọc.");
		return;
	  }

      currentPage = 1;
      
      filteredOrders = cachedOrders.filter(order => {
	  if (column === 'orders_created') {
          const orderDate = new Date(order[column]);
		const selectedDate = new Date(rawValue);
          return orderDate.toDateString() === selectedDate.toDateString();
	  } else {
          return order[column] === rawValue;
	  }
      });

	  renderOrders(filteredOrders);
	}

    function clearFilter() {
      document.getElementById('columnSelect').value = '';
      document.getElementById('valueSelect').innerHTML = '<option value="">-- Chọn giá trị --</option>';
      filteredOrders = null;
      currentPage = 1;
      renderOrders(cachedOrders);
    }

    document.getElementById('filterContainer').innerHTML += `
      <button onclick="clearFilter()" class="filter-button">
        <i class="fas fa-times"></i>
        Xóa bộ lọc
      </button>
    `;

	document.getElementById('columnSelect').addEventListener('change', updateFilterOptions);
	document.getElementById('applyFilterBtn').addEventListener('click', applyFilter);
	</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
  </body>
</html>
