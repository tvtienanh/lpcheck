<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tra Cứu Đơn Hàng</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #3E8E41; /* Màu tiêu đề */
        }

        .search-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        input[type="text"] {
            padding: 10px;
            border: 2px solid #3E8E41; /* Viền màu xanh */
            border-radius: 5px;
            font-size: 16px;
            width: 300px;
        }

        button {
            padding: 10px 15px;
            margin-left: 10px;
            background-color: #3E8E41; /* Màu nền nút */
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }

        button:hover {
            background-color: #2B6A30; /* Màu nền nút khi hover */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border: 2px solid #000; /* Viền đen */
        }

        th, td {
            border: 1px solid #000; /* Viền đen cho ô */
            padding: 8px;
            text-align: left;
            font-size: 14px;
            height: 40px; /* Chiều cao cố định cho tất cả các ô */
        }

        th {
            background-color: #A3D9E0; /* Màu header bảng */
            text-align: center; /* Căn giữa header */
        }

        .status-finished {
            color: #FFFFFF;
            background-color: #4CAF50; /* Xanh lá */
            border-radius: 25px;
            padding: 5px 9px;
        }

        .status-waiting, .status-cancelled  {
            color: #FFFFFF;
            background-color: #F44336; /* Đỏ */
            border-radius: 25px;
            padding: 5px 9px;
        }

        .status-internal {
            color: #FFFFFF;
            background-color: #9C27B0; /* Tím */
            border-radius: 25px;
            padding: 5px 9px;
        }

        .status-delivery {
            color: #FFFFFF;
            background-color: #2196F3; /* Xanh dương */
            border-radius: 25px;
            padding: 5px 9px;
        }
		
		.status-wod {
            color: #FFFFFF;
            background-color: #9126f0; /* Xanh dương */
            border-radius: 25px;
            padding: 5px 9px;
        }

        .hidden {
            display: none; /* Ẩn ghi chú */
        }

        .long-text {
            max-width: 150px; /* Kích thước cố định cho cột */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .status-column {
            width: 100px; /* Chiều rộng của cột trạng thái, điều chỉnh theo nhu cầu */
            min-width: 130px; /* Chiều rộng tối thiểu để cột không bị co lại */
            max-width: 150px; /* Chiều rộng tối đa để cột không bị kéo dài quá mức */
            text-align: center;
        }
		
		.viber-button {
		margin-left: 20px;
        display: inline-block;
        padding: 10px 20px;
        background-color: #59267C; /* Màu đặc trưng của Viber */
        color: white;
        text-decoration: none;
        border-radius: 5px;
        font-size: 16px;
        font-weight: bold;
		}

		.viber-button:hover {
		background-color: #7D3BB7; /* Màu khi hover */
		}

        .amount, .payment, .shipping-fee {
            text-align: center; /* Căn giữa */
        }
    </style>
</head>
<body>

    <h1>Tra Cứu Đơn Hàng</h1>

    <div class="search-container">
        <input type="text" id="privateCode" placeholder="Nhập mã đơn hàng, tên khách hàng,... để tra cứu">
        <button id="searchBtn" onclick="fetchOrders()">Tra Cứu</button>
		<a href="viber://chat?number=+84915665422" target="_self" class="viber-button">Liên hệ kho</a>
    </div>
	

    <table id="ordersTable">
        <thead>
            <tr>
                <th>Thời gian</th>
                <th class="status-column">Trạng thái</th>
                <th>Mã đơn hàng</th>
                <th class="long-text">Đơn đặt hàng</th>
                <th>Khách hàng</th>
                <th>Địa chỉ giao</th>
                <th class="payment">Thanh toán</th>
                <th class="amount">Giá trị đơn</th>
                <th class="shipping-fee">Phí giao hàng</th>
                <th>Thời gian giao</th>
                <th class="hidden">Ghi chú</th>
            </tr>
        </thead>
        <tbody id="ordersBody">
            <!-- Dữ liệu sẽ được thêm vào đây bằng JavaScript -->
        </tbody>
    </table>

    <script>
        async function fetchOrders() {
            const privateCode = document.getElementById('privateCode').value;
            let filterString = '';

            if (privateCode) {
                filterString = `(((contains(private_code,'${privateCode}')) or (contains(orders_cancel_reason,'${privateCode}')) or (contains(orders_code,'${privateCode}')) or (contains(orders_temp_cancel_full_reason,'${privateCode}')) or (contains(orders_temp_cancel_reason,'${privateCode}')) or (contains(pod_districts,'${privateCode}')) or (contains(orders_customer_name,'${privateCode}'))))`;
            }

            const response = await fetch("https://giaoduocpham.vn/graphql", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer BAJ2DY4ZoepiEXmAd,7670d8f330af99fa7f34e9d2158e0b7a2d50dba546f10074fdf5aa41f5cf75ecf2e0295951522e20395bca"
                },
                body: JSON.stringify({
                    query: `{
                        records: orders(skip: 0, top: 25, filters: "${filterString}") {
                            _id,
                            orders_code,
                            private_code,
                            orders_status,
                            orders_amount,
                            orders_fee_aft_vat,
                            orders_pod_name,
                            orders_customer_name,
                            orders_created,
                            mode_of_payment,
                            time_delivery_reality,
                            orders_temp_cancel_note
                        },
                        count: orders__count
                    }`
                })
            });

            const data = await response.json();
            renderOrders(data.data.records);
        }

        function renderOrders(orders) {
            const ordersBody = document.getElementById('ordersBody');
            ordersBody.innerHTML = ''; // Xóa nội dung cũ

            let hasNotes = false;  // Biến kiểm tra nếu có ghi chú

            // Sắp xếp đơn hàng theo thời gian tạo, mới nhất lên đầu
            orders.sort((a, b) => new Date(b.orders_created) - new Date(a.orders_created));

            orders.forEach(order => {
                const createdDate = new Date(order.orders_created).toLocaleDateString();
                const status = {
                    finished: `<span class="status-finished">Đã giao</span>`,
                    waiting_temp_canceled: `<span class="status-waiting">Tạm huỷ</span>`,
                    internal_transport: `<span class="status-internal">Chuyển kho</span>`,
                    delivery: `<span class="status-delivery">Đang giao</span>`,
					wod_confirmed: `<span class="status-wod">Nhập kho giao</span>`,
					temp_cancelled: `<span class="status-cancelled">Tạm huỷ</span>`
                }[order.orders_status] || order.orders_status;

                const paymentMethod = {
                    bank: 'Không thu hộ',
                    cash: 'COD'
                }[order.mode_of_payment] || order.mode_of_payment;

                const noteCell = order.orders_temp_cancel_note ? order.orders_temp_cancel_note : '';
                if (noteCell !== '') {
                    hasNotes = true;  // Đặt cờ true nếu có ghi chú
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${createdDate}</td>
                    <td class="centered">${status}</td>
                    <td class="long-text">${order.orders_code}</td>
                    <td class="long-text">${order.private_code}</td>
                    <td>${order.orders_customer_name}</td>
                    <td>${order.orders_pod_name}</td>
                    <td class="payment centered">${paymentMethod}</td>
                    <td class="amount centered">${order.orders_amount ? order.orders_amount.toLocaleString('vi-VN') : 0}</td>
                    <td class="shipping-fee centered">${order.orders_fee_aft_vat ? order.orders_fee_aft_vat.toLocaleString('vi-VN') : 0}</td>
                    <td>${order.time_delivery_reality ? new Date(order.time_delivery_reality).toLocaleString() : ''}</td>
                    <td style="border: 1px solid #000;" class="${noteCell === 'Không có ghi chú' ? '' : ''}">${noteCell}</td>
                `;

                ordersBody.appendChild(row);
            });

            const noteHeader = document.querySelector('th:nth-child(11)');
            if (hasNotes) {
                noteHeader.classList.remove('hidden');  // Hiển thị cột ghi chú nếu có ghi chú
            } else {
                noteHeader.classList.add('hidden');  // Ẩn cột ghi chú nếu không có ghi chú
            }
        }


        window.onload = () => {
            fetchOrders(); // Tự động gọi hàm fetchOrders khi trang được tải
        };
    </script>
	<!---script>
			// Responsive adjustments based on window size
		window.addEventListener('resize', function() {
			let width = window.innerWidth;
			let height = window.innerHeight;

			// Adjustments for different screen widths
			if (width < 600) {
				// Mobile adjustments
				document.body.style.fontSize = "14px"; 
				document.getElementById("ordersTable").style.width = "100%";  
			} else if (width < 1200) {
				// Tablet adjustments
				document.body.style.fontSize = "16px";
				document.getElementById("ordersTable").style.width = "90%";
			} else {
				// Desktop adjustments
				document.body.style.fontSize = "18px";
				document.getElementById("ordersTable").style.width = "80%";
			}
		});

// Hide or display specific columns based on screen width
		window.addEventListener('resize', function() {
			let width = window.innerWidth;
			const noteColumn = document.querySelectorAll('th:nth-child(12), td:nth-child(12)');

			if (width < 768) {
				// Hide the note column on smaller screens
				noteColumn.forEach(cell => {
					cell.style.display = 'none';
				});
			} else {
				// Show the note column on larger screens
				noteColumn.forEach(cell => {
					cell.style.display = 'table-cell';
				});
			}
		});

		// Adjust table height based on screen height
		window.addEventListener('resize', function() {
			let height = window.innerHeight;
			const table = document.getElementById('ordersTable');

			if (height < 800) {
				table.style.maxHeight = '400px';
				table.style.overflowY = 'scroll';  // Bật thanh cuộn dọc nếu vượt quá chiều cao
			} else {
				table.style.maxHeight = '600px';  // Màn hình lớn hơn thì tăng chiều cao bảng
				table.style.overflowY = 'auto';
			}
		});

	</script> -->
</body>
</html>
